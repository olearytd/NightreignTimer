name: iOS CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  # Set your project details here to avoid complex scripting
  PROJECT_NAME: "NightreignTimer.xcodeproj" # Or .xcworkspace if you use one
  SCHEME_NAME: "NightreignTimer" # Your primary scheme name

jobs:
  build-and-test:
    runs-on: macos-15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select latest available iPhone simulator
        id: set_simulator
        run: |
          # Select the latest available iPhone simulator
          SIMULATOR_DEVICE=$(xcrun simctl list devices available | grep "iPhone" | tail -1 | sed -e 's/.*(\(.*\)).*/\1/')
          echo "device_id=$SIMULATOR_DEVICE" >> "$GITHUB_OUTPUT"
          echo "Selected simulator ID: $SIMULATOR_DEVICE"

      - name: Build
        run: |
          xcodebuild build-for-testing \
            -scheme "$SCHEME_NAME" \
            -project "$PROJECT_NAME" \
            -destination "platform=iOS Simulator,id=${{ steps.set_simulator.outputs.device_id }}"

      - name: Test
        run: |
          xcodebuild test-without-building \
            -scheme "$SCHEME_NAME" \
            -project "$PROJECT_NAME" \
            -destination "platform=iOS Simulator,id=${{ steps.set_simulator.outputs.device_id }}"
